#!/usr/bin/env python3
"""
ì…ì°° ë¶„ì„ ê²°ê³¼ ë¦¬í¬íŠ¸ ìƒì„±ê¸°
JSON ê²°ê³¼ë¥¼ í•œê¸€ ë§ˆí¬ë‹¤ìš´ ë¦¬í¬íŠ¸ë¡œ ë³€í™˜
"""

import json
import argparse
from pathlib import Path
from datetime import datetime


def load_analysis_results(json_file):
    """JSON ë¶„ì„ ê²°ê³¼ ë¡œë“œ"""
    with open(json_file, 'r', encoding='utf-8') as f:
        return json.load(f)


def format_currency(amount):
    """ê¸ˆì•¡ í¬ë§·íŒ…"""
    return f"{int(amount):,}ì›"


def generate_markdown_report(data, output_file):
    """ë§ˆí¬ë‹¤ìš´ ë¦¬í¬íŠ¸ ìƒì„±"""

    ê³µê³ ì •ë³´ = data["ê³µê³ ì •ë³´"]
    ëª¬í…Œì¹´ë¥¼ë¡œ = data["ëª¬í…Œì¹´ë¥¼ë¡œ_ì‹œë®¬ë ˆì´ì…˜"]
    ê³¼ê±°ë¶„ì„ = data["ê³¼ê±°_1ìœ„_ë¶„ì„"]
    ê²½ìŸë°€ë„ = data["ê²½ìŸ_ë°€ë„"]
    ì†Œìˆ˜ì íŒ¨í„´ = data["ì†Œìˆ˜ì _íŒ¨í„´"]
    ëìë¦¬ = data["ëìë¦¬_ì„ í˜¸ë„"]
    ì‹¬ë¦¬ë°”ë‹¥ = data["ì‹¬ë¦¬ì _ë°”ë‹¥ì„ "]
    ì¶”ì²œì „ëµ = data["ì¶”ì²œ_ì „ëµ"]

    report = f"""# ì…ì°° ë¶„ì„ ë¦¬í¬íŠ¸

ìƒì„± ì¼ì‹œ: {datetime.now().strftime("%Y-%m-%d %H:%M:%S")}

---

## ğŸ“‹ ê³µê³  ì •ë³´

- **ê¸°ì´ˆê¸ˆì•¡:** {format_currency(ê³µê³ ì •ë³´['ê¸°ì´ˆê¸ˆì•¡'])}
- **ë°œì£¼ì²˜íˆ¬ì°°ë¥ :** {ê³µê³ ì •ë³´['ë°œì£¼ì²˜íˆ¬ì°°ë¥ ']}%

---

## 1. ğŸ² ëª¬í…Œì¹´ë¥¼ë¡œ ì‹œë®¬ë ˆì´ì…˜ (í° ê·¸ë¦¼)

> ì˜ˆì •ê°€ê²© ë¬´ì‘ìœ„ì„±ìœ¼ë¡œ ì¸í•œ ë‚™ì°°í•˜í•œê°€ ë³€ë™ ë²”ìœ„ ë¶„ì„

- **ì˜ˆì •ê°€ê²© í‰ê· :** {format_currency(ëª¬í…Œì¹´ë¥¼ë¡œ['ì˜ˆì •ê°€ê²©_í‰ê· '])}
- **ì˜ˆì •ê°€ê²© ë³€ë™í­:** {format_currency(ëª¬í…Œì¹´ë¥¼ë¡œ['ì˜ˆì •ê°€ê²©_ë³€ë™í­'])}
- **ë‚™ì°°í•˜í•œê°€ í‰ê· :** {format_currency(ëª¬í…Œì¹´ë¥¼ë¡œ['ë‚™ì°°í•˜í•œê°€_í‰ê· '])}
- **ë‚™ì°°í•˜í•œê°€ ë³€ë™í­:** {format_currency(ëª¬í…Œì¹´ë¥¼ë¡œ['ë‚™ì°°í•˜í•œê°€_ë³€ë™í­'])}
- **ê¸°ì´ˆëŒ€ë¹„ ë‚™ì°°í•˜í•œìœ¨ ë²”ìœ„:** {ëª¬í…Œì¹´ë¥¼ë¡œ['ê¸°ì´ˆëŒ€ë¹„_ë‚™ì°°í•˜í•œìœ¨_ë²”ìœ„'][0]}% ~ {ëª¬í…Œì¹´ë¥¼ë¡œ['ê¸°ì´ˆëŒ€ë¹„_ë‚™ì°°í•˜í•œìœ¨_ë²”ìœ„'][1]}%
- **ë³€ë™í­:** {ëª¬í…Œì¹´ë¥¼ë¡œ['ê¸°ì´ˆëŒ€ë¹„_ë‚™ì°°í•˜í•œìœ¨_ë³€ë™í­']}%

**ğŸ’¡ í•´ì„:** ì˜ˆì •ê°€ê²© ë¬´ì‘ìœ„ì„±ìœ¼ë¡œ ì¸í•´ ë‚™ì°°í•˜í•œê°€ê°€ Â±{ëª¬í…Œì¹´ë¥¼ë¡œ['ë‚™ì°°í•˜í•œê°€_ë³€ë™í­']/2:,.0f}ì› ë³€ë™ ê°€ëŠ¥

---

## 2. ğŸ“Š ê³¼ê±° 1ìœ„ ë¶„ì„ (ì‹¤ì œ ë‚™ì°° íŒ¨í„´)

> ê°™ì€ ë°œì£¼ì²˜íˆ¬ì°°ë¥  ê·¸ë£¹ì—ì„œ ì‹¤ì œë¡œ 1ìœ„ í•œ ì—…ì²´ë“¤ì˜ ì…ì°° íŒ¨í„´

- **ë¶„ì„ ë°ì´í„°:** {ê³¼ê±°ë¶„ì„['ë°ì´í„°_ê°œìˆ˜']}ê°œ
- **í‰ê· :** {ê³¼ê±°ë¶„ì„['í‰ê· ']}%
- **ì¤‘ì•™ê°’:** {ê³¼ê±°ë¶„ì„['ì¤‘ì•™ê°’']}%
- **í‘œì¤€í¸ì°¨:** {ê³¼ê±°ë¶„ì„['í‘œì¤€í¸ì°¨']}%
- **ìµœì†Œê°’:** {ê³¼ê±°ë¶„ì„['ìµœì†Œ']}%
- **ìµœëŒ€ê°’:** {ê³¼ê±°ë¶„ì„['ìµœëŒ€']}%

**ë°±ë¶„ìœ„ìˆ˜ ë¶„í¬:**
- 5%: {ê³¼ê±°ë¶„ì„['ë°±ë¶„ìœ„ìˆ˜']['5%']}%
- 25%: {ê³¼ê±°ë¶„ì„['ë°±ë¶„ìœ„ìˆ˜']['25%']}%
- 50% (ì¤‘ì•™ê°’): {ê³¼ê±°ë¶„ì„['ë°±ë¶„ìœ„ìˆ˜']['50%']}%
- 75%: {ê³¼ê±°ë¶„ì„['ë°±ë¶„ìœ„ìˆ˜']['75%']}%
- 95%: {ê³¼ê±°ë¶„ì„['ë°±ë¶„ìœ„ìˆ˜']['95%']}%

**ğŸ’¡ í•´ì„:** ì‹¤ì œ 1ìœ„ ì—…ì²´ì˜ 67.9%ê°€ ì¤‘ì•™ê°’ Â±0.5% ë²”ìœ„ì— ëª°ë ¤ìˆìŒ

---

## 3. ğŸ”¥ ê²½ìŸ ë°€ë„ ë¶„ì„ (íšŒí”¼ êµ¬ê°„)

> 0.05% ë‹¨ìœ„ êµ¬ê°„ë³„ ê²½ìŸ ì—…ì²´ ìˆ˜ ë¶„ì„

### âš ï¸ ì ˆëŒ€ í”¼í•´ì•¼ í•  êµ¬ê°„ (ê³ ë°€ë„)

**ìµœê³  ë°€ì§‘ êµ¬ê°„:** {ê²½ìŸë°€ë„['ìµœê³ _ë°€ì§‘_êµ¬ê°„']}

**íšŒí”¼ êµ¬ê°„ Top 5:**
"""

    for i, zone in enumerate(ê²½ìŸë°€ë„['íšŒí”¼_êµ¬ê°„_Top5'], 1):
        report += f"{i}. {zone}\n"

    report += f"""
### âœ… ì•ˆì „ êµ¬ê°„ (ì €ê²½ìŸ)

**ì•ˆì „ êµ¬ê°„ Top 10:**
"""

    for i, zone in enumerate(ê²½ìŸë°€ë„['ì•ˆì „_êµ¬ê°„_Top10'], 1):
        report += f"{i}. {zone}\n"

    report += f"""
**ğŸ’¡ í•´ì„:** ê²½ìŸì´ ì—†ê±°ë‚˜ 1~2ê°œë§Œ ìˆëŠ” êµ¬ê°„ ì„ íƒ ì‹œ ì¶©ëŒ ìœ„í—˜ ìµœì†Œí™”

---

## 4. ğŸ”¢ ì†Œìˆ˜ì  íŒ¨í„´ (0.001% ì°¨ë³„í™”)

> ì†Œìˆ˜ì  ì²«ì§¸/ë‘˜ì§¸/ì…‹ì§¸ ìë¦¬ ì„ í˜¸ë„ ë¶„ì„

### ì…‹ì§¸ ìë¦¬ ë¶„í¬

**íšŒí”¼í•  ìˆ«ì (ë¹ˆë„ ë†’ìŒ):**
"""

    for digit in ì†Œìˆ˜ì íŒ¨í„´['íšŒí”¼_ì…‹ì§¸ìë¦¬']:
        count = ì†Œìˆ˜ì íŒ¨í„´['ì…‹ì§¸ìë¦¬_ë¶„í¬'][str(digit)]
        pct = count / ê³¼ê±°ë¶„ì„['ë°ì´í„°_ê°œìˆ˜'] * 100
        report += f"- **{digit}**: {count}ê°œ ({pct:.1f}%) âš ï¸\n"

    report += "\n**ì•ˆì „í•œ ìˆ«ì (ë¹ˆë„ ë‚®ìŒ):**\n"

    for digit in ì†Œìˆ˜ì íŒ¨í„´['ì•ˆì „_ì…‹ì§¸ìë¦¬']:
        count = ì†Œìˆ˜ì íŒ¨í„´['ì…‹ì§¸ìë¦¬_ë¶„í¬'][str(digit)]
        pct = count / ê³¼ê±°ë¶„ì„['ë°ì´í„°_ê°œìˆ˜'] * 100
        report += f"- **{digit}**: {count}ê°œ ({pct:.1f}%) âœ…\n"

    report += """
**ğŸ’¡ í•´ì„:** ì†Œìˆ˜ì  ì…‹ì§¸ ìë¦¬ ìˆ«ì í•˜ë‚˜ë¡œë„ ì¶©ëŒ í™•ë¥  3ë°° ì°¨ì´

---

## 5. ğŸ¯ ëìë¦¬ ì„ í˜¸ë„

> íˆ¬ì°°ê¸ˆì•¡ ëìë¦¬ (ì› ë‹¨ìœ„) ë¶„ì„

### íšŒí”¼í•  ëìë¦¬
"""

    for item in ëìë¦¬['íšŒí”¼_ëìë¦¬'][:5]:
        pct = item['ê°œìˆ˜'] / ê³¼ê±°ë¶„ì„['ë°ì´í„°_ê°œìˆ˜'] * 100
        report += f"- **{item['ëìë¦¬']:03d}ì›**: {item['ê°œìˆ˜']}ê°œ ({pct:.1f}%) âš ï¸\n"

    report += "\n### ì•ˆì „í•œ ëìë¦¬\n"

    for item in ëìë¦¬['ì•ˆì „_ëìë¦¬'][:5]:
        pct = item['ê°œìˆ˜'] / ê³¼ê±°ë¶„ì„['ë°ì´í„°_ê°œìˆ˜'] * 100
        report += f"- **{item['ëìë¦¬']:03d}ì›**: {item['ê°œìˆ˜']}ê°œ ({pct:.1f}%) âœ…\n"

    report += f"""
**ğŸ’¡ í•´ì„:** 000, 500 ê°™ì€ ì§ê´€ì  ìˆ«ìëŠ” 50% ì´ìƒì´ ì‚¬ìš© â†’ ì ˆëŒ€ íšŒí”¼

---

## 6. ğŸ›¡ï¸ ì‹¬ë¦¬ì  ë°”ë‹¥ì„ 

- **ì•ˆì „ í•˜í•œì„ :** {ì‹¬ë¦¬ë°”ë‹¥['ì•ˆì „_í•˜í•œì„ ']}%
- **ê¶Œì¥ ìµœì†Œ ì…ì°°ë¥ :** {ì‹¬ë¦¬ë°”ë‹¥['ê¶Œì¥_ìµœì†Œì…ì°°ë¥ ']}%
- **ì‹¤ì œ ìµœì†Œê°’:** {ì‹¬ë¦¬ë°”ë‹¥['ì‹¤ì œ_ìµœì†Œ']}%
- **ì‹œë®¬ë ˆì´ì…˜ 5% ë°±ë¶„ìœ„:** {ì‹¬ë¦¬ë°”ë‹¥['ì‹œë®¬_5%ë°±ë¶„ìœ„']}%

**ğŸ’¡ í•´ì„:** {ì‹¬ë¦¬ë°”ë‹¥['ê¶Œì¥_ìµœì†Œì…ì°°ë¥ ']}% ì´í•˜ëŠ” í•˜í•œê°€ ë¯¸ë‹¬ ìœ„í—˜

---

## ğŸ¯ ì¶”ì²œ ì „ëµ ë¹„êµ

| ìˆœìœ„ | ì „ëµëª… | ì…ì°°ë¥  | ì…ì°°ê¸ˆì•¡ | ë¦¬ìŠ¤í¬ | ê²½ìŸë¦¬ìŠ¤í¬ |
|:----:|--------|-------:|---------:|:------:|:--------:|
"""

    for strategy in ì¶”ì²œì „ëµ:
        report += f"| {strategy['ìˆœìœ„']} | {strategy['ì „ëµëª…']} | {strategy['ì…ì°°ë¥ ']}% | {format_currency(strategy['ì…ì°°ê¸ˆì•¡'])} | {strategy['ë¦¬ìŠ¤í¬']} | {strategy.get('ê²½ìŸ_ë¦¬ìŠ¤í¬', 'N/A')} |\n"

    report += "\n### ì „ëµë³„ ìƒì„¸ ì„¤ëª…\n\n"

    for strategy in ì¶”ì²œì „ëµ:
        report += f"""
#### {strategy['ìˆœìœ„']}. {strategy['ì „ëµëª…']}

- **ì…ì°°ë¥ :** {strategy['ì…ì°°ë¥ ']}%
- **ì…ì°°ê¸ˆì•¡:** {format_currency(strategy['ì…ì°°ê¸ˆì•¡'])}
- **ë‚™ì°°í™•ë¥ :** {strategy.get('ë‚™ì°°í™•ë¥ ', 'N/A')}
- **ì´ìµë¥ :** {strategy.get('ì´ìµë¥ ', 'N/A')}
- **ì¡°ì • ê¸°ëŒ€ê°’:** {strategy.get('ì¡°ì •_ê¸°ëŒ€ê°’', 'N/A')}
- **ê²½ìŸ ë¦¬ìŠ¤í¬:** {strategy.get('ê²½ìŸ_ë¦¬ìŠ¤í¬', 'N/A')}
- **ë¦¬ìŠ¤í¬ ìˆ˜ì¤€:** {strategy['ë¦¬ìŠ¤í¬']}
- **ì¶”ì²œ ì´ìœ :** {strategy['ì´ìœ ']}
"""

    report += f"""
---

## ğŸ’¡ ìµœì¢… ì¶”ì²œ

### ìƒí™©ë³„ ì¶”ì²œ

- **ğŸ“Š ì¼ë°˜ì ì¸ ê²½ìš°:** {ì¶”ì²œì „ëµ[0]['ì „ëµëª…']} - {ì¶”ì²œì „ëµ[0]['ì…ì°°ë¥ ']}% ({format_currency(ì¶”ì²œì „ëµ[0]['ì…ì°°ê¸ˆì•¡'])})
  - ê³¼ê±° ì¤‘ì•™ê°’ ê¸°ë°˜ìœ¼ë¡œ ì•ˆì •ì ì¸ ì„ íƒ

- **ğŸ¯ ê²½ìŸë ¥ ì¤‘ì‹œ:** {ì¶”ì²œì „ëµ[1]['ì „ëµëª…']} - {ì¶”ì²œì „ëµ[1]['ì…ì°°ë¥ ']}% ({format_currency(ì¶”ì²œì „ëµ[1]['ì…ì°°ê¸ˆì•¡'])})
  - ê²½ìŸ ë°€ë„ ë‚®ì€ êµ¬ê°„ ê³µëµ
  - í•˜í•œê°€ ìœ„í—˜ì€ ìˆìœ¼ë‚˜ ì¶©ëŒ í™•ë¥  ìµœì†Œ

- **ğŸ›¡ï¸ ì•ˆì •ì„± ì¤‘ì‹œ:** {ì¶”ì²œì „ëµ[2]['ì „ëµëª…']} - {ì¶”ì²œì „ëµ[2]['ì…ì°°ë¥ ']}% ({format_currency(ì¶”ì²œì „ëµ[2]['ì…ì°°ê¸ˆì•¡'])})
  - ê²½ìŸ ê±°ì˜ ì—†ëŠ” ì•ˆì „ êµ¬ê°„
  - ê°€ê²© ê²½ìŸë ¥ì€ ë‚®ìœ¼ë‚˜ ì¶©ëŒ ìœ„í—˜ ì œë¡œ

### âš ï¸ í•µì‹¬ íšŒí”¼ ì‚¬í•­

1. **ì ˆëŒ€ í”¼í•  êµ¬ê°„:** {ê²½ìŸë°€ë„['ìµœê³ _ë°€ì§‘_êµ¬ê°„']}
2. **í”¼í•  ì†Œìˆ˜ì  ì…‹ì§¸ìë¦¬:** {', '.join(map(str, ì†Œìˆ˜ì íŒ¨í„´['íšŒí”¼_ì…‹ì§¸ìë¦¬'][:3]))}
3. **í”¼í•  ëìë¦¬:** 000, 500
4. **ìµœì†Œ ì…ì°°ë¥ :** {ì‹¬ë¦¬ë°”ë‹¥['ê¶Œì¥_ìµœì†Œì…ì°°ë¥ ']}% ì´ìƒ ìœ ì§€

### ğŸ“Œ ìµœì¢… ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] ê²½ìŸ ë°€ë„ ë†’ì€ êµ¬ê°„ íšŒí”¼ í™•ì¸
- [ ] ì†Œìˆ˜ì  ì…‹ì§¸ ìë¦¬ ì•ˆì „ ìˆ«ì ì‚¬ìš© (4, 6, 0)
- [ ] ëìë¦¬ 000, 500 íšŒí”¼ í™•ì¸
- [ ] ì‹¬ë¦¬ì  ë°”ë‹¥ì„  ì´ìƒ í™•ì¸ ({ì‹¬ë¦¬ë°”ë‹¥['ê¶Œì¥_ìµœì†Œì…ì°°ë¥ ']}%+)
- [ ] 0.001% ì°¨ì´ë¡œë„ ë‹¹ë½ ê²°ì •ë¨ì„ ì¸ì§€

---

**ë¶„ì„ ë°ì´í„° ê¸°ì¤€:** ë°œì£¼ì²˜íˆ¬ì°°ë¥  {ê³µê³ ì •ë³´['ë°œì£¼ì²˜íˆ¬ì°°ë¥ ']}% ê·¸ë£¹ (n={ê³¼ê±°ë¶„ì„['ë°ì´í„°_ê°œìˆ˜']})

**ìƒì„± ì¼ì‹œ:** {datetime.now().strftime("%Y-%m-%d %H:%M:%S")}
"""

    # íŒŒì¼ ì €ì¥
    with open(output_file, 'w', encoding='utf-8') as f:
        f.write(report)

    print(f"\nâœ“ ë¦¬í¬íŠ¸ ìƒì„± ì™„ë£Œ: {output_file}")

    return report


def main():
    parser = argparse.ArgumentParser(description="ì…ì°° ë¶„ì„ ê²°ê³¼ ë¦¬í¬íŠ¸ ìƒì„±")
    parser.add_argument('--json-file', type=str, required=True,
                       help='ë¶„ì„ ê²°ê³¼ JSON íŒŒì¼ ê²½ë¡œ')
    parser.add_argument('--output-dir', type=str,
                       default='/mnt/a/25/dataë¶„ì„',
                       help='ë¦¬í¬íŠ¸ ì¶œë ¥ ë””ë ‰í† ë¦¬')

    args = parser.parse_args()

    # JSON íŒŒì¼ ë¡œë“œ
    json_file = Path(args.json_file)
    if not json_file.exists():
        print(f"âŒ JSON íŒŒì¼ ì—†ìŒ: {json_file}")
        return

    print(f"\n{'='*80}")
    print(f"ì…ì°° ë¶„ì„ ë¦¬í¬íŠ¸ ìƒì„±")
    print(f"{'='*80}")
    print(f"ì…ë ¥ íŒŒì¼: {json_file}")

    data = load_analysis_results(json_file)

    # ì¶œë ¥ íŒŒì¼ëª… ìƒì„±
    agency_rate = str(data['ê³µê³ ì •ë³´']['ë°œì£¼ì²˜íˆ¬ì°°ë¥ ']).replace('.', '_')
    output_file = Path(args.output_dir) / f"report_{agency_rate}.md"

    # ë§ˆí¬ë‹¤ìš´ ë¦¬í¬íŠ¸ ìƒì„±
    generate_markdown_report(data, output_file)

    print(f"\n{'='*80}")
    print(f"ë¦¬í¬íŠ¸ ìƒì„± ì™„ë£Œ!")
    print(f"{'='*80}")


if __name__ == "__main__":
    main()
