---
name: bidding-logic
description: |
  [분석 로직 실행] 입찰 데이터를 분석하여 최적 입찰가를 계산합니다.

  실행 흐름:
  1. 몬테카를로 시뮬레이션 (10,000회) - 예정가격 분포, 낙찰하한가 변동폭
  2. 과거 1위 데이터 분포 분석 - 실제 낙찰 패턴
  3. 경쟁 밀도 히트맵 - 0.05% 단위 충돌 위험 구간
  4. 소수점 패턴 분석 - 첫째/둘째/셋째 자리 선호도
  5. 끝자리 선호도 - 000, 500 등 충돌 숫자
  6. 심리적 바닥선 탐지 - 안전 하한선
  7. 안전 구간 식별 - 경쟁 0개 구간
  8. 충돌 회피 전략 - 최종 입찰가 후보 3개 제시

  입력: 현재 공고 이미지 (기초금액, 발주처투찰률)
  출력: JSON 파일 (분석 결과 + 추천 입찰가 3개)

  Use when: 입찰 데이터 분석 수행, 최적 입찰가 계산
  (project)
---

# 입찰 분석 로직 - 통합 실행 Skill

## 목적

입찰 공고 이미지를 입력받아 **최적 입찰가 3개 후보**를 계산합니다.

## 사용법

```bash
# Skill 호출
Skill tool → command: "bidding-logic"

# 또는 직접 실행
python3 /mnt/a/25/.claude/skills/logic/analyze.py \
  --base-amount 39000000 \
  --agency-rate 87.745 \
  --data-file /mnt/a/25/data전처리완료/투찰률_87_745%_데이터.xlsx
```

## 실행 흐름

### Phase 1: 몬테카를로 시뮬레이션 (큰 그림)

```python
# 10,000회 시뮬레이션
- 15개 예비가격 생성 (기초금액 ±3%)
- 4개 무작위 선택 → 평균 = 예정가격
- 낙찰하한가 = 예정가격 × (발주처투찰률 / 100)
- 기초대비 낙찰하한율 분포 계산

결과: "87.X% 근처에 입찰하라" (±0.5% 범위)
```

### Phase 2: 과거 1위 데이터 분포 분석

```python
# 실제 낙찰 패턴
- 같은 발주처투찰률 그룹 1위만 필터링
- 기초대비투찰률 분포 히스토그램
- 평균, 중앙값, 표준편차 계산
- 백분위수 (5%, 25%, 50%, 75%, 95%)

결과: "실제 1위는 87.843% (중앙값)"
```

### Phase 3: 경쟁 밀도 히트맵 (0.001% 단위 차별화)

```python
# 0.05% 단위 구간별 업체 수
bins = np.arange(86.0, 90.0, 0.05)
hist, edges = np.histogram(past_1st_rates, bins=bins)

# 히트맵 색상
for i, count in enumerate(hist):
    if count > 10: color = 'red'    # 회피!
    elif count > 5: color = 'orange'
    elif count > 2: color = 'yellow'
    else: color = 'green'            # 안전!

결과: "87.85~87.90% 붉음 (10개 충돌) → 회피!"
     "87.70~87.75% 녹색 (2개) → 안전"
```

### Phase 4: 소수점 패턴 분석

```python
# 첫째 자리 (87.Xxx%)
first_decimal = (rates * 10 % 10).astype(int)
# 87.3XX% → 17개 (15.2%) ← 가장 많음

# 둘째 자리 (87.xXx%)
second_decimal = (rates * 100 % 10).astype(int)
# 87.x5x% → 15개 (13.4%) ← 회피

# 셋째 자리 (87.xxX%)
third_decimal = (rates * 1000 % 10).astype(int)
# 87.xx8% → 19개 (17.0%) ← 절대 회피!
# 87.xx4% → 6개 (5.4%) ← 안전

결과: "87.xx8% 회피, 87.xx4% 선택"
```

### Phase 5: 끝자리 선호도 분석

```python
# 투찰금액 끝자리 (원 단위)
amounts = base_amount * rates / 100
endings = amounts % 1000

# 빈도 분석
000: 50% ← 절대 회피!
500: 15%
100: 8%
575: 2% ← 안전 (비직관적)

결과: "34,258,575원 (끝자리 575)"
```

### Phase 6: 심리적 바닥선 탐지

```python
# 아무도 입찰하지 않는 구간
min_safe_rate = past_1st_rates.min() - 0.1
# 예: 86.764% - 0.1 = 86.664%

# 하지만 너무 낮으면 미달 위험
simulated_min_winning_rate = monte_carlo_results.percentile(5)
# 예: 86.523%

# 안전 하한선
safe_floor = max(min_safe_rate, simulated_min_winning_rate)

결과: "86.6% 이하는 위험, 86.7% 이상 유지"
```

### Phase 7: 안전 구간 식별

```python
# 경쟁 0개 구간
for start, end in bins:
    if hist[i] == 0 and start >= safe_floor:
        print(f"안전 구간: {start}% ~ {end}%")

결과: "88.75% ~ 88.80% (0개)"
     "89.10% ~ 89.15% (0개)"
```

### Phase 8: 충돌 회피 최종 전략

```python
# 3가지 전략
strategy_1 = {
    "name": "중앙값 전략 (안정적)",
    "rate": past_median + micro_adjust,  # 87.843% + 0.001%
    "amount": base_amount * rate / 100,
    "risk": "중간",
    "reason": "과거 1위 중앙값 기반, 소수점 조정으로 충돌 회피"
}

strategy_2 = {
    "name": "저경쟁 구간 (공격적)",
    "rate": 87.734,  # 경쟁 밀도 낮은 구간
    "amount": base_amount * 0.87734 / 100,
    "risk": "높음",
    "reason": "경쟁 적지만 하한가 위험"
}

strategy_3 = {
    "name": "고안전 구간 (보수적)",
    "rate": 88.043,  # 경쟁 0개 + 충분한 마진
    "amount": base_amount * 0.88043 / 100,
    "risk": "낮음",
    "reason": "안전하지만 가격 경쟁력 낮음"
}

결과: 3개 후보 제시
```

## 출력 파일 형식

```json
{
  "공고정보": {
    "기초금액": 39000000,
    "발주처투찰률": 87.745
  },
  "몬테카를로_시뮬레이션": {
    "예정가격_평균": 38995307,
    "낙찰하한가_변동폭": 1613255,
    "기초대비_낙찰하한율_범위": [85.677, 89.813]
  },
  "과거_1위_분석": {
    "데이터_개수": 112,
    "평균": 87.851,
    "중앙값": 87.843,
    "표준편차": 0.505
  },
  "경쟁_밀도": {
    "최고_밀집_구간": "87.65~87.70% (7개)",
    "회피_구간": ["87.85~87.90%", "88.30~88.35%"],
    "안전_구간": ["87.70~87.75%", "88.75~88.80%"]
  },
  "소수점_패턴": {
    "회피_셋째자리": [8, 7, 1],
    "안전_셋째자리": [4, 3, 9]
  },
  "추천_전략": [
    {
      "순위": 1,
      "전략명": "중앙값 전략",
      "입찰률": 87.8437,
      "입찰금액": 34258943,
      "리스크": "중간",
      "충돌확률": "낮음",
      "이유": "과거 중앙값 + 소수점 조정"
    },
    {
      "순위": 2,
      "전략명": "저경쟁 구간",
      "입찰률": 87.734,
      "입찰금액": 34216260,
      "리스크": "높음",
      "충돌확률": "매우낮음",
      "이유": "경쟁 밀도 낮음"
    },
    {
      "순위": 3,
      "전략명": "고안전 구간",
      "입찰률": 88.043,
      "입찰금액": 34336770,
      "리스크": "낮음",
      "충돌확률": "없음",
      "이유": "경쟁 0개 구간"
    }
  ]
}
```

## Python 스크립트

분석 스크립트: `/mnt/a/25/.claude/skills/logic/analyze.py`

## 주의사항

⚠️ **반드시 같은 발주처투찰률 그룹 데이터 사용**
- 87.745% 그룹 → `투찰률_87_745%_데이터.xlsx`
- 86.745% 그룹 → `투찰률_86_745%_데이터.xlsx`

⚠️ **하한가 미달 데이터는 제외하지 않음**
- 심리적 바닥선 분석에 필수

⚠️ **기초대비투찰률 사용 (예가대비 X)**
- bidding-core skill 참조

## 성공 기준

✅ 3개 전략 모두 충돌 확률 < 5%
✅ 전략 1은 과거 중앙값 기반
✅ 소수점 셋째 자리까지 차별화
✅ JSON 파일 생성 완료
